\chapter{P2P Content Delivery}
\section{Introduction}

P2P applications such as Napster, Gnutella, FastTrack, BitTorrent, Skype and PPLive, have attracted the end users.
According to the P2P paradigm, the P2P network is formed by peers that equally share the computing resources in a cooperative manner.
Each peer contributes of its resources such as network bandwidth, storage, etc. 
As the nodes of P2P grows, the capacity of the network grows, too because many peers join to the network. 
This enables a P2P application is cheap and it can be used for content delivery.  

We noted that the popular P2P file sharing applications are Gnutella, eDonkey, and Bittorrent.  
Gnutella is one of the earliest P2P file sharing applications in the Internet.
Gnutella is pure P2P applications that do not use a centralized server.
A Gnutella peer joins the network via at least one known peer.
That known peer IP address is obtained via pre-configured addresses. 
From this initial Gnutella peer, we can discover new Gnutella peers.
The Gnutella peer will send the search request to all connected peers. 
The recipient peer will answer the query if it knows anything. 
The recipient peer can forward the request to other peers if it does not know the answer.
Thus, The query will propagate among the Gnutella network.
Therefire Gnutella will floods the network for searching.

Other P2P applications is eDonkey.  
This applications is very popular in Europe. 
The eDonkey network operates as a hybrid P2P and server. 
The eDonkey network consists number of of clients and number of servers. 
IP address of server is usually pre-configured when user installing the applications for the first time.  
If users want to change the server, user can read on eDonkey web portal.
The eDonkey server is working as a indexes files and for distributing IP addresses of other eDonkey peers to the eDonkey users.

BitTorrent was created in 2002 by Bram Cohen. 
It runs on an open protocol specification thus there a lot of Bittorrent implementation.
To share a file or a set of files through BitTorrent, a torrent file must be created for the first time.  
The torrent file contains the information of the content, which includes the information of the tracker and the hashes of the file blocks to be distributed.
The torrent file is usually distributed via Bittorent web portals.
When a client wants to get a file that shared in Bittorrent web portals, it must obtain the torrent file from Bittorrent portals.
The client then contacts the trackers listed in the torrent file to obtain a list of peers that are sharing the file at the same time.  
BitTorrent has generated great enthusiasm for P2P file sharing distribution due to simplicity.  
Many open source software projects use Bittorrent to distribute their applications which is quite big enough (equal or than CD disk space).
Important terms in Bittorrent: a seeder is a client who has complete the content and a leecher is a client who download the content.

Beside of P2P for filesharing, we also noted that P2P for streaming is also on the rise especially in China.
The target of P2P streaming is to build a scalable P2P platform for TV/music delivery. 
More than a dozen companies are actively working in this area for example UUSe, PPLive, PPStream.  
Let's take PPLive as an example since it is the most popular P2P streaming service.
According to \cite{} in 2007, the number of concurrent users for the most popular PPLive session raises to 1.5 million.
When the PPLive client is launched by users, it retrieves from a channel servers the metadata information of all channels. 
After users choose the channel, the PPLive client further talks to a tracker of that channel. 
Next the trackers will give  a list of peers that are watching the same channel. 
After getting a list of peers, the PPLive client connects to a set of peers, and starts to exchange data. 
The challenge in P2P streaming is to provide a sustained streaming bit rate to all peers joining the network. 
Unlike P2P file sharing, where the content can be carried on a best effort basis, in P2P streaming, insufficient delivery bandwidth can lead to poor quality of service. 

\begin{figure}[tb]
\begin{center}
\includegraphics[scale=0.6]{../../../papers/p2p-cdn-latex/tex/ipsj/graphs/p2p-technologies.eps}
\end{center}
\caption{P2P technologies building block.} 
\label{fig:p2ptech}
\end{figure}

Figure \ref{fig:p2ptech} shows the presentation of P2P technologies building block.
It is not easy to identify an overall architecture in which the various P2P services related to content delivery. 
The bottom level provides the basic networking abstractions, i.e., the P2P overlay networks. 
The middle level provides additional P2P services for delivery and management (including searching)
Above them, we can see P2P applications which work on the top of previous blocks.
Additional overlay abstractions can be exist in the middle to help delivery process. 
For examples:  mesh structure and gossip service.
Finally, security, trust and cooperation are seen as cross-layer issues including the mismatches between P2P applications cooperation and ISPs.

All P2P networks run on top of the Internet. 
We often consider the P2P network as an overlay network on the top of Internet. 
We classified overlay to: structured, unstructured, and hierarchical. 
Structured overlays is a virtual address space and assign overlay addresses to peers in this space which defines neighborhood relationships between peers.
The function of structured overlay is for storing and locating objects. 

In unstructured systems, the unstructured overlay do not enforce any particular structure in the network. 
Unstructured overlay networks typically close to random graphs. 
In unstructured P2P networks, peers usually do have not the same role with other peers.
In unstructured P2P networks, a peer can choose any other peers as neighbor to the some degree of freedom.  

In hierarchical overlay network, we can say that unstructured architectures with superpeers are hierarchical networks.
The superpeers is forming the top level and ordinary peers the bottom level.
In hierarchical overlay network peers are organized in different groups and each group can runs its own overlay. 

Searching for content in overlay network is one of the key services in P2P which attracted  and still attracts a lot of attention.
In P2P networks, indices can be centralized, localized, or distributed. 
In structured overlay network centralized indices typically rely on a unique entity in the structured overlay network that stores the index. 
In unstructured overlay network localized indices is usually use for searching. 
Therefore, a query looking for a particular content must be propagated among peers.
However, indexing does not solve content poisoning problem in P2P.

In structured overlay networks, due to fix structured form, this networks can provide the support for exact match queries.  
Let's take Distributed Hash Table (DHT) for example. 
It has key and address of available content therefore a search operation results is fast and efficient.

Replication is tied with P2P networks.  
Let's take example in Bittorrent.  
If a user download content in Bittorrent,  it means that user replicated the contents.  
The block of content that already downloaded replicated in his/her PC and that block can be downloaded by other peers that need.
Consistency is important in Bittorrent, that's why Bittorrent provide hash for every block for checking the right block and reject bad block from fake content.

Gossiping is a simple and effective mechanism to spread the information. 
In P2P overlay networks, each peer participating in a gossiping process contacts of other peers in random and exchange the information between them.
In push gossip, the contacted peers receive a piece of information from the contacting peer. 
In pull gossip, the contacted peers send a piece of information to the contacting peer. 
In Bittorrent implementation gossiping is in push and pull mode and the set of peers to contact is chosen at random.

Another important aspect in security of P2P is related to trust, and particularly to establishment of reputation. 
Establishing reputation of peers requires collecting information about previous interactions. 
For example, Bittorrent tracker usually has log to record the peers behavior. 
If a peer has bad upload/download ratio, Bittorrent tracker can blacklist that peer to join the Bittorrent swarm since the tit-for-tat policy of Bittorrent is the basis of cooperation enforcement.

We highlight an important aspect related to the impact of P2P technologies on ISP policies (cross layer issues). 
P2P solutions are network agnostic, in the sense that they do not take any consideration the layer 3 of the network paths. 
Having agnostic P2P solutions can cause problems at different levels to ISPs. 
It has been shown that blind selections of neighbors in P2P networks may result in unnecessary traversal of multiple links inside an ISP. 
Furthermore, it can significantly impact on the shape and amount of traffic among different ISPs, which may result being quite different from what foreseen in ISPs peering agreements.
Although, many solution to this problem are exist, the implementations are still not deployed widely.  

While algorithms and mechanism in P2P system has been analyzed by many researchers, measurement of P2P is other aspect that important to do. 
First example: in cross layer issue, P2P is often blind in selection of neighbors in P2P networks that affect underlying ISP's traffic engineering policies.  
This effect can only seen if we have good real measurement instead doing simulation.
Second example: in Bittorrent economic model, reseachers wants to understand the content publishing phenomena. 
The growing popularity of Bittorrent is primary due to the availability of valuable content without any cost for users.
However, publishing valuable content has legal implications for the users who publish the content.
This raise the question that if content publisher behave in altruistic manner or financial incentives. 
This question can only be answered by doing measurement in real Bittorrent swarm. 

Energy was another aspect that is quite separated from current P2P research but now that topic becomes to rise. 
While popularity of P2P is decline because users now the content to the cloud, in some region P2P filesharing (e.g. Bittorent) applications is still popular.
In parallel to the development of P2P services, ISPs have evolved from providing basic Internet connectivity to offering higher valued services such as Internet+TV+phone triple-play, or recent quad-play. 
The STBs or home gateways play an increasingly important role in this evolution since the services for user configured in this STB or home gateway.
The latest STB generations are similar to small PC. 
In this context, these devices can be used to deploy the  P2P services. 
Therefore, it is very important to considering energy consumption of in P2P.


\section{P2P Measurement}

Bittorrent is the most successful Peer-to-Peer (P2P) application and was responsible for a major portion of Internet traffic in the past.
This has attracted the interest of the research community to evaluated the performance and the demographic aspects of BitTorrent.
Example current popular an application that use Bittorrent like protocol is Spotify which is a very popular streaming music application in Europe and US.
Bittorent has been largely studied using simulations, models and real measurements. 
Although simulations and modelling are easier to perform, they typically simplify the problems and they are likely to miss some of the effects which occur in real Bittorent swarms. 
Several techniques have been used in order to measure different aspects of BitTorrent so far. 
Since many popular applications work based on Bittorrent like protocol these days, we will focus on it.

\subsection{Measuring BitTorrent}
In this sub section we describe the BitTorrent measurement techniques defined in the literature so far. 
We classify them into two main categories macroscopic and microscopic depending on the retrieved information. 
Table \ref{tab:measurementtechniques} shows the summary of different techniques on Bittorrent measurement. 

\begin{table}[thb]
\caption{Comparison of Measurement Techniques in Bittorrent.}
\label{tab:measurementtechniques}
\hbox to\hsize{\hfil}
\begin{tabular}{c|c|c|c}\hline\hline
Property & Portal crawling & Tracker crawling & Peers crawler \\ \hline
Scope & macroscopic & macroscopic & microscopic \\ \hline
Information level & torrents level & demographics and  & peer level performance \\ 
 &  & general performance  & \\ \hline
Cost of crawler preparation & low & medium & high \\ \hline
Obtained result details & basic & medium & high \\ \hline
Peers population results & - & high & very high \\ \hline
\end{tabular}
\end{table}

\subsubsection{Macroscopic Technique}
The goal macroscopic technique is to understand the demographics of the Bittorrent ecosystem for example the type of published content, the popularity of the content, the distribution of BitTorrent users per country, etc. 
The macroscopic measurement allows us to get the performance information such as the ratio of between seeder to leechers, the session time of the Bittorrent users, the seedless state (period the torrent is without seeder) duration, etc.
We can classify the macroscopic techniques into two categories: Bittorrent portals crawling and Bittorrent trackers crawling.

\begin{itemize}
\item BitTorrent portals crawling: 
The (major) Bittorrent portals index millions of torrents in a structured way. 
They provide detailed information about each indexed torrent on a specific torrent web page. 
Once we know the how Bittorrent portals indexing the torrents, we can crawl the Bittorrent portals using that index.
If we want to analyze the demographics of Bittorrent, we need to crawl a large number of torrents.
This is take time since millions of torrents exist in Bittorrent portals, every second a new torrent can be published to Bittorrent portals (including fake torrent).
By processing the data from the Bittorrent crawling, we can get the information related to Bittorrent demographics.
For example: content popularity distribution, distribution of published content, and publishing rate of new torrents.
It's depends on Bittorrent web portals, some Bittorrent portals do not give detail information about the torrent information. 

\begin{figure}[tb]
\begin{center}
\includegraphics[scale=0.6]{../../../papers/p2p-cdn-latex/tex/ipsj/graphs/tracker-crawling.eps}
\end{center}
\caption{Bittorrent tracker crawling: The Bittorrent crawler fetch the torrent file from Bittorrent portals. Using information from torrent file, the Bittorrent crawler contacts the Bittorrent tracker by sending announce message. The Bitorrent tracker will reply by giving list of seeders and leechers. This process is repeated until obtain all the peers in the swarm.} 
\label{fig:trackercrawling}
\end{figure}


\item BitTorrent trackers crawling:
While crawling Bittorrent portals can give us information about the torrent type and torrent publisher and some number of seeders and leechers, that technique is not sufficient for more detail information such as distribution of users per country or performance relevant information such as peers arrival rate and peers session time.
To get that information, we need to collect IP address of seeders and leechers in the Bittorrent swarms.  
This information can only get from Bittorrent tracker logs by asking to Bittorrent tracker owners or by crawling the Bittorent tracker.
Figure \ref{fig:trackercrawling} shows the schematic of Bitorrent tracker crawling.  
First, a Bittorrent crawler needs to download torrent file from Bittorrent portal.  
Next, a Bittorrent crawler send announce message to Bitorrent tracker and Bitorrent tracker will reply by giving list of seeders IP address and list of leechers IP address.  
A Bittorrent crawler send announce message again to Bitorrent tracker. 
Since Bitorrent tracker has been recorded the IP address of the Bittorrent crawler, Bittorrent tracker will reply by giving list of leechers IP address only. 
This process repeat as many as possible to get list of leechers IP address.
If a Bittorrent crawler send too many announce message, Bittorrent tracker will block the Bittorrent crawler. 
Hence, this technique must be done in friendly way for Bittorrent tracker.
Another challenge is in Bittorrent the peers do not have a permanent peer-id.  
Everytime Bittorrent client is started a new random peer-id is generated thus it is very difficult to follow a peer using its peer-id. 
On the other since most of the Bittorrent client is home user which the IP address is assigned in a dynamic way by ISP, identifying peers by their IP address can introduce inaccuracies. 
\end{itemize}

\begin{figure}[tb]
\begin{center}
\includegraphics[scale=0.6]{../../../papers/p2p-cdn-latex/tex/ipsj/graphs/peer-crawling.eps}
\end{center}
\caption{Peer crawling: The initial process in same with the Bittorrent tracker crawling with additional steps for the Bittorrent crawler to contact all the peers in the swarm by sending handshakre request. The contacted peers will reply by sending BITFIELD message and HAVE message.} 
\label{fig:peeercrawling}
\end{figure}

\subsubsection{Microscopic Technique}
While in macroscopic techniques we can get the peers IP level information, that information does not sufficient to infer more detail performance metrics at the peer level such as peers download and upload rate, and how peers can connect each other (graph of the network).
To get this information, we need more sophisticated techniques that implement wire level Bittorent protocol since the crawling techniques in this case means join directly to Bittorrent swarm.
Figure \ref{fig:peeercrawling} shows the schematic functionality of peer crawling.  
In this peer crawling technique, a Bittorrent crawler get the IP address of peers participating in a swarm.
The initial process is same with tracker crawling. 
Afterwards, the Bitorrent crawler contact each peer and performs the handshake procedure. 
The contacted peers will reply by sending BITFIELD and HAVE message.
From handshake response we can get information if the peers is using public IP address space or behind NAT. 
Basically if contacted peers response to the Bittorrent crawler then that peers is using public IP address space and if that peers silent then that peers are behind NAT.
From BITFIELD message we can get information about peers type: seeder or leecher.   
By measuring the time between the reception of two consecutive HAVE messages from a peer, the Bittorrent crawler can calculate the time needed to download a chunk.
Chunk size information is always available in torrent file.
Thus, dividing the size of the chunk by the time need to download two consecutive HAVE message, we can infer the instantaneous downlaod rate of a peer.
BITFIELD message contains information about chunks that already has in every peer in the swarms.  
Thus by comparing BITFIELD message for every peers in the swarm,  we can infer the chunk distributions in the swarms.
Challenges in this technique is the Bittorrent crawler can be blocked by a peer because it send many handshake message and receive many BITFIELD and HAVE message from a peer but the Bittorrent crawler does not upload any information to the peer.





\section{Energy Aspect of P2P Network}

Since the seminal paper by Gupta and Singh \cite{Gupta:2003:GI:863955.863959}, the subject of green networking has received considerable attention. 
In recent years, valuable efforts have been devoted to reducing unnecessary energy expenditure.
Big companies and data center operator are turning to a host of new technologies to reduce operating costs and consume less energy.
Google, for example, is planning to operate its data centers with a zero carbon footprint by using, among other things, hydropower, water-based chillers, and external cold air to do some of the cooling.
While energy is mostly concerned by companies that run hundred of server and hundred of networking devices inside data center, only a little considering is made for home users. 
Remembering that P2P applications was the largest fraction of the Internet traffic in the past, although it is now decline due to the popularity of content sharing via cloud computing, we still have many popular P2P application that run based on P2P paradigm.  
For example, spotify.
Spotify is fee based music streaming service for mobile and desktop. 
It is very popular in Europe and USA. 
Spotify works like Bitorrent though there are several difference.
These figures shows that making P2P applications more energy efficient is important.
These days ISPs have evolved from providing basic Internet connectivity to offering higher valued services such as Internet+TV+phone.
In this value added service, the STBs or home gateways play an increasingly important. 
This STBs is same powerfull as PC desktop while the shape quite small compared to desktop PC. 
However, the powerfull of STB means consume more power. 
Since broadband home Internet users are increasing, consideration to reduce energy consumption of STB is required. 

Several approaches have been considered to reduce energy consumption. 
For example: Dynamic Voltage Scaling (DVS) and Dynamic Frequency Scaling (DFS) can be used to reduce energy consumption.
With DVS the supply voltage is reduced when not needed, hence we can get slower operation of circuit.
DFS can reduce the number of processor instructions, thus reducing performance.
Another approach is designing new network architectures.
For example: placing optical amplifiers at the most convenient locations and the task functions near renewable sources.
Performing resource consolidation, capitalizing on available energy is also considered as a way to reduce energy consumption.
This can be done via traffic engineering. 
Another way is by migrating computation or delegate the workload, typically using virtualization to move workloads transparently.

Due to the complexity of P2P networks, DVS and DFS can be implemented in hardware level.  
While in network level, migrating computation task is the another way to reduce energy consumption.  
For example in \cite{6249349}, Gianetti et al. propose the usage of Bittorrent proxy for  delegating the Bittorrent client work. 
Delegating some work to Bittorrent proxy can save up to $25\%$ of energy usage for PC desktop used for Bittorrent file sharing.

While most network architecture energy consumption has been explored, a little work is done in exploring energy consumption in hybrid network architecture fashion. 
For example: energy consumption in combination of P2P and data center (CDN or Cloud).


